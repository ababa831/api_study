# Chapter02 エンドポイントの設計とリクエストの形式

大まかな流れ

1. 何をAPIとして公開するのか
2. どういったAPIを公開するのか
    - 公開する機能の設計
    - エンドポイントの設計

## 2.1 APIとして公開する機能を設計する

何を公開するのか?

提供したいもの
-> 機能設計
e.g. SNSサービス

- ユーザ情報の登録・編集
- 友達の検索，追加，削除
- 友達の間でのメッセージのやりとり

-> テーブルを[ユーザ, ソーシャルグラフ情報, タイムライン]の3つのカラムを検索，編集すれば実現可能
-> しかし
- SQLのリレーション，データの内部情報がわからないと使えない
- 内部情報の公開はセキュリティ的に危ない

-> もっと高次元（高レベル）な機能にすべき

その方法: ユースケースをより細かく・深く考える

まず考える視点は，誰・何処に向けたサービスなのかターゲット（目的）を明確に．例：モバイルアプリのバックエンドとして利用を想定

手順:
1. 想定するアプリの画面遷移を考える
2. 画面遷移を実現するために必要な機能を列挙する
   - 例
     - ユーザ登録
     - ログイン
     - 自分の情報の取得
     - etc.
3. 列挙した機能で画面遷移が本当に実現可能か，過不足が無いか流れを追いながら考える
4. （そのままだと使いづらいので，）列挙した機能をわかりやすく纒める，グループ化する．

## 2.2 APIエンドポイントの考え方・設計法

### 2.2.1 エンドポイントの基本的な設計

エンドポイントはURI -> URI設計の原則に従う

良いURI: **覚えやすく，どんな機能を持つURIなのかひと目でわかる**

理由:
使うのは主に開発者.開発者が
- エンドポイントを間違う
- 利用方法を間違う

確率を下げ,

- 開発者の生産性向上
- APIの評価向上
- 大量アクセス等の間違った使い方の予防

等の効果が得られるため

**覚えやすくわかりやすいURI**
- 短く入力しやすい
- 人間が読んで理解できる
- 大文字小文字が混在していない
- 改造しやすい（Hackableな）
- サーバ側のアーキテクチャが反映されていない
- ルールが統一されている

#### 2.2.1.1 短く入力しやすいURI

シンプルで覚えやすいから

覚えにくい
- 不要な情報が含まれる
- 意味が重複している

場合が多いので注意しろ

e.g.
- OK http://api.example.com/search
- NG http://api.example.com/service/api/search

#### 2.2.1.2 人間が読んで理解できるURI

URIの文字列だけで，何を目的としたものなのかある程度わかるようにしたい．

理由: 
- APIの意図がひとめでわかれば，ドキュメントを毎回見る必要がなくなる
- わかりやすいURIなら，間違ったAPIアドレスにアクセスするミスが低減

NGな例: http://api.example.com/sv/u/

- sv
- u

が何を意味しているのかわからない


予防策
- むやみに省略形を用いない
  - 自国の開発者だけがわかるような省略法もだめ
  - 標準化した省略法は例外 e.g. `jp`
- APIでよく使われる英単語を用いる
  - e.g. searchとfindの使い分けは，ネイティブ以外は難しい -> この場合はこういう単語がよく使われている！という選び方をすれば大外しはしない
  - 実際に他のAPIやそのドキュメントをみれば，どんな単語がよく使われているかわかってくる
- スペルミスをなくす
  - ドキュメントや書籍にのこってしまうとつらいぞ
  - 利用する開発者に余計な負担を強いるぞ
  - 特に複数形，過去形

#### 2.2.1.3 大文字小文字が混在していないURI

e.g.
- NG http://api.example.com/getUserName

理由
- わかりづらい
- 間違えやすい

小文字が標準化されているから小文字を使え

↑の例について，
- get_user_name
- get-user-name

にすれば良いかといえばそういうわけではない

**名前の付け方に問題あり** -> そのうち後述

[大文字小文字が混ざったときの扱い方]
- どちらでも同じ結果を返す方法
  - Googleは複数の同一ページをもつと解釈し，ページランク下げる
    - しかし，APIはSEO気にしなくて良いので301リダイレクトにするかとかをあまり気にしなくて良い
- 小文字だけのURIにリダイレクトする方法
- NotFoundをのエラーを返す方法
  - HTTPの仕様（RFC 7230）上，スキーマと小文字を除いて大文字小文字区別OKなので，大文字を入れた場合エラー出す仕様でも問題ない
- 小文字じゃないとダメよ的なエラーメッセージを返す方法


#### 2.2.1.4 改造しやすい（Hackableな）URI
HATEOAS
RESTを拡張する概念
＊全てのエンドポイントは，処理の流れの中でリンクとしてサーバから提供されるべきであり，クライアントはURIをHackしてアクセスすべきではない＊ という考え方 


#### 2.2.1.5 サーバ側のアーキテクチャが反映されていないURI
サーバサイドのソフトウェア，言語，ディレクトリ・システム構成がわかるようなURIをつけるんじゃねええ．
脆弱性を突きたい野郎共の格好の的

e.g.
NG: ｀https://api.example.com/cgi-bin/get_user.php?user=100｀

いらない: サーバ側のアーキテクチャ，ディレクトリ構成
いる:
- 機能
- データの構造と意味


#### 2.2.1.6 ルールが統一されたURI
ルール: URIとして利用する単語，URIの構造がエンドポイント間で統一されている

OK
- ｀https://api.example.com/friends/100｀
- ｀https://api.example.com/friends/100/messages｀

NG (単数形複数形統一とれていない，上段はIDにパスを入れる形になってしまっている)
- ｀https://api.example.com/friends?id=100｀
- ｀https://api.example.com/friend/100/message｀

## 2.3 HTTPメソッド
(一部メモ省略，TODO: あとでまとめる)

修正: PUT
生成: POST
一部更新: PATCH

#### 2.3.5.1 GET/POSTしか認められていない時に，PUT/DELETEを使う方法
- X-HTTP-Method-Override
- _method (Ruby on Rails採用 ContentTypeで表されるデータ ｀application/x-www-form-urlencoded｀ として送信)

x-hogehoge　みたいに ｀x-｀ という接頭語が付いているのはIANA (Internet Assigned Numbers Authority) に登録された正式なメディアタイプ

前者の方が使いやすい
その理由:
- 後者は ｀application/x-www-form-urlencoded｀  以外でデータ送信に利用できない
- 後者はリクエストにデータ以外のメタ情報が入ってしまう -> 送信データ分類の観点で好ましくない （←どういうことか理解できてない）
- 前者はサーバ側のフレームワーク，ミドルウェアが標準サポート -> 実装やテストの手間が軽減