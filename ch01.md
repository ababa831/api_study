# Chapter01 Web APIとは何か

- HTML 最終的に人間がブラウザ上で「読む」ことを前提とした情報が埋め込まれている
- API データを直接活用するための形式．さまざまな目的の二次加工に利用しやすい

### 本書の扱う範囲
URIにアクセスすると，シンプルにJSONやXMLが帰ってくる[XML over HTTP], [JSON over HTTP]と呼ばれるAPI

### 本書の目的
世の中には，厳密なルール・仕様に沿わず設計されたAPIががある．本書はちゃんとAPIを設計するためにはどうしたら良いかを目的とする

### REST
[XML over HTTP], [JSON over HTTP]を [REST API]と呼ぶ場合があるが，本来厳密な定義が存在している．単にHTTP経由でJSONとかを返すAPIをREST APIと呼ぶのは誤用or拡大解釈ね．本書では誤解を招かないように，こうした「広義のREST」をRESTとは呼ばないぞ （編集済み） 
（安易にRESTとか言いっちゃいそうになるけど，パブリックで使うとREST警察が来そうだから注意しよう．．）

## 1.1 WEB APIの重要性

近年，APIの存在が企業やサービスの収益や価値を左右するから
（Webサービスを提供しているのにAPIを公開してないのならば，はよ公開せい！）

過去の成功例: [2003 Amazon Product Advertising API] (EC2やS3が公開される以前)
このときはAWS ＝＝ Product Advertising APIだった

APIがアフィと結び付けられてた -> これを使って誰もがカンタにAmazonの商品を自分のサイトから販売し，その収益の一部を得られた -> ブログの普及とあいまって，Amazonの商品を購入するリンクがいたるところに貼り付けられる -> Amazonの収益めっちゃUP

過去の成功例2: [2006~ Twitter]
Twitter自体がシンプルなサービスだったので，APIを使うことで殆どの操作が可能だった

e.g. ガラケー読み書き，より使いやすいクライアント，データ分析サービス，Bot, etc.
-> 殆どの情報が集まる場 巨大なエコシステム化

Q. 無料で提供すると損しない？
A. 近視眼的にはそう見える．しかし，APIを公開すると外部の開発者が色々いじいじしてくれて，新しい付加価値を与えてくれるので，コアとなる自分たちのサービスがより発展する力が得られる

Q. APIを有料利用すると，自前で運用するよりコストかかりそうじゃない？
A. 自前で運用した場合は
- 開発・運用の人件費
- 開発にかかる時間
- 運用する能力をもつ人材を探すコスト
がかかる．そう考えると，API利用した方が割安だったりする

また，デファクトなサービス，よく使われているサービスでありAPIが公開されているならそれをつなぎ込んだ方が有利
なぜ？：つなぎ先のサービスを利用している人は別サービスに移行する必要がない -> ユーザにとって利用開始するコストが非常に下がるから

### 1.1.2 モバイルアプリケーションとAPI
スマホがサーバと通信する場合，WebAPI（外部には公開してないやつ）を使うケースが一般的．スマホ中心の世の中だからそりゃ重要だよね

### (おまけ)Swagger

[Swaggerまとめ](https://qiita.com/gcyata/items/342073fa7607fd4082bd)

UI上でどのAPIがいきてるのか(get, post, put, patch, delete)わかったり、paramかえて実際にrequest投げたり等便利

### 1.1.3 APIエコノミー
APIが重要性を増してきたので，APIそのものの構築や管理をビジネスとして行うサービスが増えてきた
このように，APIを中心としてビジネスが発展していくこのは＊APIエコノミー＊とよばれ近年注目 (この本は2013年ごろ) 

## 1.2 さまざまなAPIのパターン

APIを設計しなければならないケース
- 公開しているWebサービスのデータ・昨日をAPIとして提供するとき
- 他のページに貼り付けるウィジェットの公開
- モダンなWebアプリケーションの公開
- スマホアプリの開発
- ソシャゲの開発
- 社内システムの連携

### 1.2.1 公開しているWebサービスのデータ・昨日をAPIとして提供するとき
見ず知らずの第三者が利用することが前提

->

- きちんとドキュメント公開しろ
- 誰でもわかりやすい設計にしろ
- ユーザ登録・ユーザごとのアクセス制限などが必要な場合も
- 仕様変更する際，変更前のままを引きずって利用するユーザを考慮した戦略をとれ
- モバイルクライアント向けSDKの公開も検討しなきゃいけない場合もあり

### 1.2.2 他のページに貼り付けるウィジェットの公開
e.g. Facebookのいいねとか，アマゾンアフィのリンクとか

サードパーティJavaScriptで提供
- JavaScriptがバックエンドにあるAPIにアクセスして情報を送受信
- ウィジェット専用のAPIを用意することがある
- 第三者がウィジェットを作れるように公開する場合もある

設計にあたり考慮すべきこと
- ブラウザを使って他ページからAPIへのアクセスが行われる -> クロスドメインのアクセスサポート要
（クロスドメインってなに？ あとで調べる）
- ブラウザでアクセスできるので，クライアント側のコード誰でも簡単に読める -> なりすまし，不正アクセスがカジュアルにできやすくなる

[クロスドメインの解説](https://wa3.i-3-i.info/word15224.html)

### 1.2.3 モダンなWebアプリケーションの構築

- **昔** Webアプリは情報の切り替えの際にページが遷移
- **今** ページ読み込み・遷移とは別タイミングで情報を取得したり様々な機能を共有するのが当たり前

Why:<br>
- やり取りするデータサイズを小さくする
- やり取りタイミングをいい塩梅に調整する

ことで，より良いUXを提供可能だから

**こうしたサイトを構築する際APIは必須**

e.g. AJAX

JavaScript -> WebサーバからWebAPIを通して逐次情報を取得

[1.2.2 他のページに貼り付けるウィジェットの公開](https://github.com/ababa893/api_study/blob/master/ch01.md#122-%E4%BB%96%E3%81%AE%E3%83%9A%E3%83%BC%E3%82%B8%E3%81%AB%E8%B2%BC%E3%82%8A%E4%BB%98%E3%81%91%E3%82%8B%E3%82%A6%E3%82%A3%E3%82%B8%E3%82%A7%E3%83%83%E3%83%88%E3%81%AE%E5%85%AC%E9%96%8B)の場合と同じように，ブラウザからのアクセス前提．しかし，自サイトでアクセスする点が異なる

### 1.2.4 スマホアプリの開発

Web APIの用途:<br>
サーバとクライアントとのつなぎこみ

クライアントはスマホだから，中身（リクエスト・レスポンス）を覗くのは難しくない．

しかし
- ブラウザで利用するAPIほどカジュアルではない．-> 不正アクセスはやや面倒
- 一般に公開しないAPIの場合もある

Q. 従って，設計は適当でよい？

A. そんなことはない．
- ネットワークを[スニファリング](https://wa3.i-3-i.info/word16811.html)すればすぐにわかる．不正アクセス対策を怠るな！
- サーバ側でリソース一括管理できるブラウザと異なり，スマホアプリはクライアント側のコードがUpdateされるまでは古いままなので，APIのUpdateを戦略的にする必要がある

### 1.2.5 ソシャゲの開発

マルチプレイするから，クライアントサーバ間の通信は必ず発生

MMORPGと比べてそこまでリアルタイム性を要求されないから，手軽なAPIが用いられがち

->設計ちゃんとしろよー

あと，チート野郎が多発するから，不正アクセス対策は抜かりなくすべし！

### 1.2.6 社内システムの連携

社内のニーズや要件に合わせて都度つくられたり改修されたりする．

-> 

- 様々な時期
- 様々な部署

で作られたものが乱立

そしてそれらが複雑に連携したり，お互いに直接DBにアクセスしたりすると．．．

**一箇所の変更がドミノ倒しに他のシステムの不具合を引き起こす危険性が増す**

->

各システムの実装を疎結合にしておくと，被害が最小限で済む

## 1.3 何をAPIで公開すべきか

提供しているサービスのコアとなる価値のある部分を全て公開せい

e.g. 家計簿アプリ
- 家計簿の記入，これまでの履歴の取得 -> 公開すべき
- 通貨の変換機能 -> コアじゃないので価値を生み出さない．公開しなくて良い

### 1.3.1 APIを公開するリスクはあるのか

Q. API外部に公開したら，データ盗まれないの？<br>
Q. 自分たちの利益が他に取られるのでは？<br>

A. 杞憂だ

理由:
1. 利用者が少ないなら盗もうとするやつなんかいねえよ．むしろユーザ数少ないサービスを使ってもらったら付加価値つけてもらえるかもよ．
2. アクセス数（リクエスト数）を制限すれば，大量にデータ収集・それを転用したサービスのパクリも不可能．大量にデータ収集したいなら，それ相応の使用料を払ってもらえばOK．どのみち利用者は自分たちのインフラ上にて手のひらで転がされている．ユーザを囲い込んだあと後で有償化してしまうなども考えられる．
3. 盗みたいやつはAPI化してなくても，Webスクレイピングでとっくに収集している．また，Webページを勝手にAPI化できちゃうサービスもあるから，むしろAPIとして利用させた方がそういう利用を抑え込むなどコントロールしやすい

### 1.3.2 APIを公開することで得られるメリット

- 自分たちのサービスの質や情報の質が上がるかも
  - 人手が足りずに実装できていなかった物を第三者がいい感じにつくってくれるかも
  - 思いつきもしない機能をつくってくれるかも
  - e.g. Twitterに対する, Togetter, Twitpic等
- 自分たちのサービス価値を落とすものに対してはAPIの利用制限も可能
  - 利用規約で定めればよい
  - あからさまなスパムとかは弾くようにしろ
  - 気に食わないとかの理由だと反感を買いかえって価値が下がるから慎重に

APIエコノミーは，直販に対する間接販売の発展と同じような流れだと指摘する識者がいる(San Ramji) 

## 1.4 Web APIを美しく設計する重要性

美しい設計
- 良く考えられている
- わかりやすく整理されている
- 無駄がない

美しく設計した方が良い理由
- 使いやすい
- 変更しやすい
- 頑強である
- 恥ずかしくない

### 1.4.1 使いやすい

- APIを利用するのは自分ではないことが多い
- 利用する側の立場によって使い勝手が左右される
- できるだけ多くの人に触ってほしい

などの理由による

### 1.4.2 変更しやすい

Webサービス，システムはどんどん進化していくから，APIの変化も余儀なくされる

しかし，第三者が使う場合，APIを変えても古いバージョンのままの可能性がある．

こうなったときに，古いバージョンのAPIが動作しなくなったら影響出るので，
いかに影響なく移行できるように設計していくこと重要

### 1.4.3 頑強である

- セキュリティ的に問題ない
- APIならではの問題を対策している

## 1.5 Web APIを美しくするには

- 仕様に従う
- 仕様が存在しなければ，デファクトスタンダードに従う

Note: 真似を単純にしろという話ではない．

- 標準的な仕様は，開発者の長年かけたレビューによって培われたものだから，枯れてて安心
- 詳細なドキュメントがなくても他の開発者がトレースしやすい

理由を考えながら設計・開発していくのが重要

## 1.6 RESTという単語にこだわるな

モダンなWeb APIでは，一部RESTの原則に従わない方が良いケースがあったりもして，そういうのをRESTって呼ぶと誤解を産みやすいので，本書ではできるだけRESTとは言わない

## 1.7 対象となる開発者の数とAPIの設計思想

- LSUDs (large set of unknown developers) 大多数のにわか開発者
- SSKDs (small set of known developers) 少数の玄人開発者

どちらのユーザを対象にしたAPIなのかで，設計の仕様が変わる場合がある．つまり，その対象の使い勝手に合わせた設計にすることが重要

